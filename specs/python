#!/usr/bin/env bash
source "$(cd "$(dirname "$0")" && pwd)/../pretty-print"

packages=(
	pip
	awscli
	awsebcli
	credstash
	pipenv
	pylint
	pywatchman
	yq
)

title "Python"

if [ "$FORCE" = true ] || ! brew list pyenv > /dev/null; then
	step "Installing pyenv"
	brew install pyenv > /dev/null
	print_in_green "${bold}✓ installed!${normal}\n"
fi

version="3.7.3"

if ! pyenv versions | grep -q $version; then
	echo_install "Installing python v$version"
	pyenv install $version &> /dev/null
	pyenv global $version &> /dev/null
	print_in_green "${bold}✓ installed!${normal}\n"
else
	print_success_muted "python $version (pyenv)"
fi

which pip3 | grep -q .pyenv/shims || print_error "Please add 'eval \"\$(pyenv init -)\"' to your .*rc file"
eval "$(pyenv init -)"

for package in "${packages[@]}"; do
	echo_install "Upgrading $package"
	pip3 install --upgrade $package --quiet
	print_in_green "${bold}✓ done!${normal}\n"
done

# This is a hack to get watchman working in python 3
# https://github.com/facebook/watchman/issues/631
sed -i '' 's/basestring/str/g' ~/.pyenv/versions/$version/bin/watchman-make